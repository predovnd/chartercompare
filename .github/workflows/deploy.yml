name: Deploy to Azure App Service

on:
  push:
    branches:
      - dev
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy from (default: dev)'
        required: false
        default: 'dev'
        type: string

env:
  CLIENT_PATH: client
  SERVER_PATH: server
  API_PROJECT: server/CharterCompare.Api/CharterCompare.Api.csproj
  MIGRATIONS_PROJECT: server/CharterCompare.Migrations/CharterCompare.Migrations.csproj
  DOTNET_VERSION: '8.0.x'
  NODE_VERSION: '18.x'

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      has-client: ${{ steps.check.outputs.has-client }}
      has-server: ${{ steps.check.outputs.has-server }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.branch || github.ref }}
      - name: Check if client exists
        id: check
        run: |
          if [ -d "${{ env.CLIENT_PATH }}" ] && [ -f "${{ env.CLIENT_PATH }}/package.json" ]; then
            echo "has-client=true" >> $GITHUB_OUTPUT
          else
            echo "has-client=false" >> $GITHUB_OUTPUT
          fi
          
          if [ -d "${{ env.SERVER_PATH }}" ] && [ -f "${{ env.API_PROJECT }}" ]; then
            echo "has-server=true" >> $GITHUB_OUTPUT
          else
            echo "has-server=false" >> $GITHUB_OUTPUT
          fi

  build-and-test:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has-server == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.branch || github.ref }}
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Restore dependencies
        run: dotnet restore ${{ env.API_PROJECT }}
      
      - name: Build
        run: dotnet build ${{ env.API_PROJECT }} --configuration Release --no-restore
      
      - name: Run tests (if any)
        continue-on-error: true
        run: |
          if find ${{ env.SERVER_PATH }} -name "*.Tests.csproj" -o -name "*Test*.csproj" | grep -q .; then
            dotnet test --configuration Release --no-build --verbosity normal
          else
            echo "No test projects found, skipping tests"
          fi

  build-client:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has-client == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.branch || github.ref }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.CLIENT_PATH }}/package-lock.json
      
      - name: Install dependencies
        working-directory: ${{ env.CLIENT_PATH }}
        run: npm ci
      
      - name: Build client
        working-directory: ${{ env.CLIENT_PATH }}
        env:
          # Use empty string for relative URLs when frontend and backend are on same domain
          # This makes API calls relative to the current domain (Azure App Service URL)
          # Empty string is preserved in code using nullish coalescing (??) instead of logical OR (||)
          VITE_API_URL: ''
        run: npm run build
      
      - name: Upload client build
        uses: actions/upload-artifact@v4
        with:
          name: client-dist
          path: ${{ env.CLIENT_PATH }}/dist
          retention-days: 1

  publish-server:
    runs-on: ubuntu-latest
    needs: [build-and-test, build-client]
    if: always() && (needs.build-and-test.result == 'success' || needs.build-and-test.result == 'skipped') && (needs.build-client.result == 'success' || needs.build-client.result == 'skipped' || needs.build-client.result == 'failure')
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.branch || github.ref }}
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Restore dependencies
        run: dotnet restore ${{ env.API_PROJECT }}
      
      - name: Publish server
        run: dotnet publish ${{ env.API_PROJECT }} --configuration Release --output ./publish --no-restore
      
      - name: Download client build (if exists)
        if: needs.build-client.result == 'success'
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: client-dist
          path: ./client-dist
      
      - name: Copy client to wwwroot
        if: needs.build-client.result == 'success'
        run: |
          mkdir -p ./publish/wwwroot
          cp -r ./client-dist/* ./publish/wwwroot/
      
      - name: Create deployment package
        run: |
          cd publish
          zip -r ../deployment.zip .
          cd ..
      
      - name: Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: deployment.zip
          retention-days: 1

  deploy-dev:
    runs-on: ubuntu-latest
    needs: publish-server
    environment:
      name: dev
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.branch || github.ref }}
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Install EF Core Tools
        run: dotnet tool install --global dotnet-ef || dotnet tool update --global dotnet-ef
      
      - name: Restore dependencies
        run: dotnet restore ${{ env.API_PROJECT }}
      
      - name: Run Database Migrations
        env:
          CONNECTION_STRING: ${{ secrets.AZURE_SQL_CONNECTION_STRING }}
        run: |
          if [ -z "$CONNECTION_STRING" ]; then
            echo "Warning: Connection string not configured. Skipping migrations. App will auto-migrate on startup if enabled."
          else
            echo "Running EF Core migrations..."
            dotnet ef database update \
              --project ${{ env.MIGRATIONS_PROJECT }} \
              --startup-project ${{ env.MIGRATIONS_PROJECT }} \
              --connection "$CONNECTION_STRING" \
              --verbose
            echo "Migrations completed successfully."
          fi
        continue-on-error: true
      
      - name: Download deployment package
        uses: actions/download-artifact@v4
        with:
          name: deployment-package
          path: ./deployment-package
      
      - name: Deploy to Azure App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ secrets.AZURE_APP_NAME }}
          publish-profile: ${{ secrets.AZURE_PUBLISH_PROFILE }}
          package: ./deployment-package/deployment.zip

