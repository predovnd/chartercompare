name: Deploy to Azure App Service

on:
  push:
    branches:
      - dev
      - staging

env:
  CLIENT_PATH: client
  SERVER_PATH: server
  API_PROJECT: server/CharterCompare.Api/CharterCompare.Api.csproj
  INFRASTRUCTURE_PROJECT: server/CharterCompare.Infrastructure/CharterCompare.Infrastructure.csproj
  DOTNET_VERSION: '8.0.x'
  NODE_VERSION: '18.x'

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      has-client: ${{ steps.check.outputs.has-client }}
      has-server: ${{ steps.check.outputs.has-server }}
    steps:
      - uses: actions/checkout@v4
      - name: Check if client exists
        id: check
        run: |
          if [ -d "${{ env.CLIENT_PATH }}" ] && [ -f "${{ env.CLIENT_PATH }}/package.json" ]; then
            echo "has-client=true" >> $GITHUB_OUTPUT
          else
            echo "has-client=false" >> $GITHUB_OUTPUT
          fi
          
          if [ -d "${{ env.SERVER_PATH }}" ] && [ -f "${{ env.API_PROJECT }}" ]; then
            echo "has-server=true" >> $GITHUB_OUTPUT
          else
            echo "has-server=false" >> $GITHUB_OUTPUT
          fi

  build-and-test:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has-server == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Restore dependencies
        run: dotnet restore ${{ env.API_PROJECT }}
      
      - name: Build
        run: dotnet build ${{ env.API_PROJECT }} --configuration Release --no-restore
      
      - name: Run tests (if any)
        continue-on-error: true
        run: |
          if find ${{ env.SERVER_PATH }} -name "*.Tests.csproj" -o -name "*Test*.csproj" | grep -q .; then
            dotnet test --configuration Release --no-build --verbosity normal
          else
            echo "No test projects found, skipping tests"
          fi

  build-client:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has-client == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.CLIENT_PATH }}/package-lock.json
      
      - name: Install dependencies
        working-directory: ${{ env.CLIENT_PATH }}
        run: npm ci
      
      - name: Build client
        working-directory: ${{ env.CLIENT_PATH }}
        run: npm run build
      
      - name: Upload client build
        uses: actions/upload-artifact@v4
        with:
          name: client-dist
          path: ${{ env.CLIENT_PATH }}/dist
          retention-days: 1

  publish-server:
    runs-on: ubuntu-latest
    needs: [build-and-test, build-client]
    if: always() && (needs.build-and-test.result == 'success' || needs.build-and-test.result == 'skipped') && (needs.build-client.result == 'success' || needs.build-client.result == 'skipped' || needs.build-client.result == 'failure')
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Restore dependencies
        run: dotnet restore ${{ env.API_PROJECT }}
      
      - name: Publish server
        run: dotnet publish ${{ env.API_PROJECT }} --configuration Release --output ./publish --no-restore
      
      - name: Download client build (if exists)
        if: needs.build-client.result == 'success'
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: client-dist
          path: ./client-dist
      
      - name: Copy client to wwwroot
        if: needs.build-client.result == 'success'
        run: |
          mkdir -p ./publish/wwwroot
          cp -r ./client-dist/* ./publish/wwwroot/
      
      - name: Create deployment package
        run: |
          cd publish
          zip -r ../deployment.zip .
          cd ..
      
      - name: Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: deployment.zip
          retention-days: 1

  deploy-dev:
    runs-on: ubuntu-latest
    needs: publish-server
    if: github.ref == 'refs/heads/dev'
    environment:
      name: dev
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Install EF Core Tools
        run: dotnet tool install --global dotnet-ef || dotnet tool update --global dotnet-ef
      
      - name: Restore dependencies
        run: dotnet restore ${{ env.API_PROJECT }}
      
      - name: Run Database Migrations (Dev)
        env:
          CONNECTION_STRING: ${{ secrets.AZURE_SQL_CONNECTION_STRING_DEV }}
        run: |
          if [ -z "$CONNECTION_STRING" ]; then
            echo "Warning: Connection string not configured. Skipping migrations. App will auto-migrate on startup if enabled."
          else
            echo "Running EF Core migrations for dev environment..."
            dotnet ef database update \
              --project ${{ env.INFRASTRUCTURE_PROJECT }} \
              --startup-project ${{ env.API_PROJECT }} \
              --connection "$CONNECTION_STRING" \
              --verbose
            echo "Migrations completed successfully."
          fi
        continue-on-error: true
      
      - name: Download deployment package
        uses: actions/download-artifact@v4
        with:
          name: deployment-package
          path: ./deployment-package
      
      - name: Deploy to Azure App Service (Dev)
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ secrets.AZURE_APP_NAME_DEV }}
          publish-profile: ${{ secrets.AZURE_PUBLISH_PROFILE_DEV }}
          package: ./deployment-package/deployment.zip

  deploy-staging:
    runs-on: ubuntu-latest
    needs: publish-server
    if: github.ref == 'refs/heads/staging'
    environment:
      name: staging
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Install EF Core Tools
        run: dotnet tool install --global dotnet-ef || dotnet tool update --global dotnet-ef
      
      - name: Restore dependencies
        run: dotnet restore ${{ env.API_PROJECT }}
      
      - name: Run Database Migrations (Staging)
        env:
          CONNECTION_STRING: ${{ secrets.AZURE_SQL_CONNECTION_STRING_STAGING }}
        run: |
          if [ -z "$CONNECTION_STRING" ]; then
            echo "Warning: Connection string not configured. Skipping migrations. App will auto-migrate on startup if enabled."
          else
            echo "Running EF Core migrations for staging environment..."
            dotnet ef database update \
              --project ${{ env.INFRASTRUCTURE_PROJECT }} \
              --startup-project ${{ env.API_PROJECT }} \
              --connection "$CONNECTION_STRING" \
              --verbose
            echo "Migrations completed successfully."
          fi
        continue-on-error: true
      
      - name: Download deployment package
        uses: actions/download-artifact@v4
        with:
          name: deployment-package
          path: ./deployment-package
      
      - name: Deploy to Azure App Service (Staging Slot)
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ secrets.AZURE_APP_NAME_PROD }}
          publish-profile: ${{ secrets.AZURE_PUBLISH_PROFILE_PROD }}
          slot-name: staging
          package: ./deployment-package/deployment.zip

  migrate-production:
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.ref == 'refs/heads/staging' && success()
    environment:
      name: prod
      # Manual approval required for production migrations
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Install EF Core Tools
        run: dotnet tool install --global dotnet-ef || dotnet tool update --global dotnet-ef
      
      - name: Restore dependencies
        run: dotnet restore ${{ env.API_PROJECT }}
      
      - name: Check for Pending Migrations (Production)
        env:
          CONNECTION_STRING: ${{ secrets.AZURE_SQL_CONNECTION_STRING_PROD }}
        run: |
          if [ -z "$CONNECTION_STRING" ]; then
            echo "Error: Connection string not configured for production. Please set AZURE_SQL_CONNECTION_STRING_PROD secret."
            exit 1
          fi
          echo "Checking for pending migrations in production..."
          dotnet ef migrations list \
            --project ${{ env.INFRASTRUCTURE_PROJECT }} \
            --startup-project ${{ env.API_PROJECT }} \
            --connection "$CONNECTION_STRING" \
            --verbose || echo "No migrations found or database doesn't exist yet."
        continue-on-error: true
      
      - name: Run Database Migrations (Production)
        env:
          CONNECTION_STRING: ${{ secrets.AZURE_SQL_CONNECTION_STRING_PROD }}
          RUN_MIGRATIONS: ${{ github.event.inputs.run_migrations || 'false' }}
        run: |
          if [ "$RUN_MIGRATIONS" != "true" ]; then
            echo "Production migrations require explicit approval."
            echo "To run migrations manually, use: dotnet ef database update --project ${{ env.INFRASTRUCTURE_PROJECT }} --startup-project ${{ env.API_PROJECT }} --connection \"$CONNECTION_STRING\""
            echo "Or set 'run_migrations' input to 'true' in workflow_dispatch event."
            exit 0
          fi
          
          if [ -z "$CONNECTION_STRING" ]; then
            echo "Error: Connection string not configured for production."
            exit 1
          fi
          
          echo "⚠️  RUNNING PRODUCTION MIGRATIONS - This will modify the production database!"
          dotnet ef database update \
            --project ${{ env.INFRASTRUCTURE_PROJECT }} \
            --startup-project ${{ env.API_PROJECT }} \
            --connection "$CONNECTION_STRING" \
            --verbose
          echo "✅ Production migrations completed successfully."
  
  promote-to-production:
    runs-on: ubuntu-latest
    needs: migrate-production
    if: github.ref == 'refs/heads/staging' && success()
    environment:
      name: prod
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_SP_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_SP_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_SP_TENANT_ID }}"
            }
      
      - name: Swap staging to production
        uses: azure/CLI@v2
        with:
          inlineScript: |
            az webapp deployment slot swap \
              --resource-group ${{ secrets.AZURE_RESOURCE_GROUP_PROD }} \
              --name ${{ secrets.AZURE_APP_NAME_PROD }} \
              --slot staging \
              --target-slot production
